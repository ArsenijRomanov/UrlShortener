services:
  redis:
    image: redis:alpine
    container_name: url-redis
    ports:
      - "6379:6379"
    restart: unless-stopped

  db-master:
    image: postgres:15-alpine
    container_name: postgres-master
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: simplepass
      POSTGRES_DB: url_db
    ports:
      - "5432:5432"
    volumes:
      - db-master-data:/var/lib/postgresql/data
      - ./init-master.sh:/docker-entrypoint-initdb.d/init-master.sh
    command: postgres -c wal_level=replica -c max_wal_senders=10 -c max_replication_slots=10 -c hot_standby=on -c listen_addresses='*'
    restart: unless-stopped

  db-slave:
    image: postgres:15-alpine
    container_name: postgres-slave
    depends_on:
      - db-master
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: simplepass
      POSTGRES_DB: url_db
    ports:
      - "5433:5432"
    volumes:
      - db-slave-data:/var/lib/postgresql/data
      - ./init-slave.sh:/docker-entrypoint-initdb.d/init-slave.sh
    command: postgres -c hot_standby=on
    restart: on-failure

  writeservice:
    build:
      context: .
      dockerfile: WriteService/Dockerfile
    container_name: url-writeservice
    ports:
      - "8082:8080"
    depends_on:
      - db-master
      - redis
    environment:
      - ConnectionStrings__WriteDb=Host=db-master;Port=5432;Database=url_db;Username=user;Password=simplepass
      - ConnectionStrings__Generator=http://generator:8080
      - RedisCacheConnection=redis:6379
      - SECRET_KEY=your_url_hashing_secret_key
    restart: unless-stopped

  readservice:
    build:
      context: .
      dockerfile: ReadService/Dockerfile
    container_name: url-readservice
    ports:
      - "8081:8080"
    depends_on:
      - db-slave
      - redis
    environment:
      - ConnectionStrings__ReadDb=Host=db-slave;Port=5432;Database=url_db;Username=user;Password=simplepass
      - ConnectionStrings__Redis=redis:6379
    restart: unless-stopped

  generator:
    build:
      context: .
      dockerfile: Generator/Dockerfile
    container_name: url-generator
    ports:
      - "8083:8080"
    depends_on:
      - db-master
    restart: unless-stopped

  apigateway:
    build:
      context: .
      dockerfile: ApiGateway/Dockerfile
    container_name: url-apigateway
    ports:
      - "8080:8080"              # снаружи:8080 -> внутри:8080 (Kestrel в ApiGateway)
    depends_on:
      - writeservice
      - readservice
    environment:
      # Kestrel слушает на 8080 во всех интерфейсах
      - ASPNETCORE_URLS=http://+:8080
      - ASPNETCORE_ENVIRONMENT=Development
      # База коротких ссылок, которая попадёт в ShortUrlBase (используется при формировании shortUrl в ответе)
      # Для локальной разработки логично указывать URL самого gateway:
      - ShortUrlBase=http://localhost:8080

      # gRPC адреса для WriteService и ReadService
      # В коде используются ключи конфигурации "Grpc:WriteService" и "Grpc:ReadService",
      # поэтому в env их задаём как Grpc:WriteService и Grpc:ReadService.
      # Внутри docker-сети сервисы доступны по своим именам: writeservice, readservice.
      - Grpc:WriteService=http://writeservice:8080
      - Grpc:ReadService=http://readservice:8080

    restart: unless-stopped

volumes:
  db-master-data:
  db-slave-data:
